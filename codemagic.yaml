workflows:  
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmdvNUtWaDlzVHFLOEZ1MmN4VTlHSnlnbTJjVzhxZEt4aFU3Wmc2LVZGMTYxbnNKTlRCdHdOU2ZBY0h4bDgya1pfLVBtenE1Z2g4UUxiSVFCb2VJZFZnRENYMXdZYm5wMGV5T2xrM3U5T3ZZV3Y4Wk9NWmRxVTlGUmlnaFVQVXlla2lvSzE=) # <-- Put your encrypted App Store Connect Issuer Id here 
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmdvNUx5OXRtMGtTbE5ZcFRNOGhqWDFLcWlYUlZBSUgxdW1DakFERjVoNG5NNnZCeE9KSFhzak1KcmRWcTd3LS0tVzlnZXZXc0FmSnBKV3lVbHJlbWhMOF9WTWc9PQ==)
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdvNU1tS3d0bVZRVHRjQTZkQVRJcEZuOE1DR0ZsMmk1ZWpqNVNhbjR0WENYZHVoaFcyb1NfaG5maGtpZFpTOVdkV0RqcTNwUEZfWFFudGZ1dXU5d0RhdkZ6WXJpTFg1dGNLVWdtVEJqakJlT1BvOVI0djVEUkhVSzN1N1lYOWpkN1JUVUtocWlacERRMWpJbDZDVVlVcW1JeHNieWJGdTdNV3I3LXNkZE1hSGN1SUEyY0NmY1RFdzM3Xzd5d0ZkUzROZFVpcE11NS1Zd2c2UnB2TFR2dm0xOWRXbnc3U0NlYWR2VV84ZzMyQTFJa2xkV2RCeU9NYk0yTmx6dlZxemRDdjVNc3VXaTkxbUhvRjJnQU0wRTZXTXJpVS1la1JsOVpkTTQ5OHZCeGZwaXNwVlBIeE15LVdjOEFfV0c5Mm5YZUNaOERUUlpRMkpWMFJoSU5jbWVwblpOR1o0T2JlZF9HeUZFUWttY0FkOGVzekZqOHhLcDluNjNnTVBVTVZvWWpCRFA2cElkbXRGTFU3RlZldkpBWVZaLTV4bVRRaG1lY2lxbVYzM053ZmVobTBpeGtyOVhXQlg4OWQzSGtOOUtWRUFfelU4bm0zZ0RBdTBRZG9DVEFUTlEyc19aMnBxeVdUTFgyYzM1MUstWE4wRVd3Qkg4T2V4OXNVVUpaSFRnU1ZPTlJxaFMtcVBuVjNIZ0M1Um9RTEd6WjR3PT0=)
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdvNU5VMUdwc3VwVmtYM2lOMHMyUFNTT3dsNlFyN2wtSGszbzRULU9hdnByWERFcXJzQl9PbGlzcGVEOWF2UXQ1b1RkX3g3VHZ3ZW9rVFRSSjJJUWFOWVJiOWZNX2ZueUJSLVE4UGNfZkJZZDlTNU5SZFdDNy1yNmFaLXc2TTNQZVZrNUlMVnY5aUZFSDBGSm1zVklQREtVWU5KZnp0czVpVUVBX2lTVGJVQW5YeTBHaGN4U19LWXhacGY3YkplaGRwcEl2YzdOSndVUlVtVG8wQ1ZUZEZ3UGtFRlk3blBIN18wYXgxdGw0cHVsaFdnNXlFTWtEVGhRSG5JTVhEM3JWS1dtS3A3bWZNRVNRNDdCcmlrR1hkbDVEUEhRdFFIYmV6Z2dkTndxdUFIVHRiQU9ZS2lpMm5JMnFOb2taV0NTbjZzTHo0NVVtRDBnWFdYTmExUjhtMXZzUXZQLTdJWEZCVWY5aDBLZUNEZGhwOTVqU0RPQV9BM29CanpHZlVCckJORXMzMDJCR0E4cTcxS1NfcDRWcDNjNmdrYS1SSEJ6NmJWbC1PU3FiWGZOeWxQaTBZNTdRdGpPZnJDNE00SF9HWG5hc25tSXZFSFVqMUZDRk85YVBUSEdQcTJSMURSYTlfN0EzbEpTQ1RPSU0tN1YtUDJHUWVKRGFsS25xQmtmbFBadkdUa1dVci1McjJockNpR1pkOWg5Zm9pb2dZRzRQclVMVE14Z2Q5OGtsQW9TNl9sVEhqdjJ3VHNqZU43a204TFdwMm90RUJneUtIWXJGZVNmU09FQlFYcElVVG9BMXlKeU5SYlhGa2hBMHdjaENtWFRsVUdCd3JqYkp5RVRpNUlVX3dzSUJ4MVVvZjlqX2IyWWRPMVNwUm9xX1NqUW8xZENLWGZhV29SVnE4MnYxV0dYTjh5bjFVZ3pfcE5ZeTY4Qmh1bGxEbUJrb0FndXFGT2tGN1RadlJHVEE0c2Joc0RuNEZMWmRXUnZCUkJFV212emU1ai1PMURudTloMUJEWmtCZjg5bUQzcFVWdXhoMW9VVjJrVjdYaGNocTBINTJ5SzVBa09zQjdIWWJ3MTlQeUR3Q0xMNVg1TkVYZUl6WVRXVFpabVA5LS1LSUxyeUxLc0xJR2d3NVBRaWVqalB4UmhzOU1HSEhQRTJGUENMU1JNTnZ5RHp1bERxaUZxNXZOMnI2UWNVRTBqdUxOZ2VhQ3lsU090TFY5VExMMFNDMEMzQzJRbFV4eTBnMVhyVXVBOFgtNGJvbGNKTzdtc3JkV08taEo5WDBZMm4yb3ZDSmlqY1BIU1lFdm9PZERZVnVvdjhoVEx3QXpIaElTenBYR0Ffc2E5WFF1YkV0eEgtRTJ6SlAyN01EYXRzMzl5RjBhWVNUTERZSkkydVFaRGxzNjZwYW84YVUzUUNLMnhqeXdlWWd0RllkOHhyaWhWa1VlNTVhRjZnRlRTYzdrRUJOSDFpVkJHS2YyUHNGWG40aDBldzRkd1pOLTNaMmtfem1PZzY4LWpvbmp0MlItbERsN0ZYNEZtNnpkNDR5TkV4OHlQclJjVmNNbmhzSHpiNEZndms2b3ZYT0tOOTVkSnhNMHRiMlRoNFl2azhxNHFMN09ETHZrYXFSNDBJbjBFR01La2RtaUo4T3hrQ3JCT2h5em1kV0JRbVdpMGU0eVRoMEtieWdMV1ktaFA4MEZwYXllUk1nc3IyRWJCMTFLTl81Y1J0dFN0dWpWVE5hajJIc1FsZEJ5QUZtWmVJTkxIMDQ0d1VMYkY2QU12dFp3WmtiUi1OZkpkaDRjMnRfVFZESy0wS1BJSWVDd01IR1NCaG5WY1l5cnBFMUVfZ2ltZTJCNENMTHJKbVhKM2dpNVgweG91eU5BWTVtLTJ3d2c1NXRmTllWbWZWZ2hmRHROZGZVYzZPWUw2UTUtamg5OWxvYnpndWt3ejdON0wzMEdQNllWQUQ5X0VJaXBEOG5BczUtT0EzWVlYeUZXNkhjNEMwLUN0SlctR2prODBYUGJBaExNaGlUQzdYWVltY0R2YnY1a0lyR0R3SUVhQTlMenJqNmpZclZVc21GOW1tU1dZZXVKclJHWHVvOGFJU1dRaEQ3OVNXckF4RklQTXZUV3EzYmloZzJya0Q3RkhRZ2JqczYzLTY1ZEFqT0NBTHBkNDhIY1VWeFdxS0d5eFhCVENTbVBBSmFRVktDYjV6dWRWWHk2MmdScTlsV3JDb2dqQW1HdTRMOU0zc3JVMHJLcVN4QnUweXhpNWkzNWQzOUxueFl5c0ZiaDE2WXIxM1MxbHNEMnRKTGJIMjRHX0JheW00VUZFZjdhRlBfTGJiazdfOTZkX3Rxd2ZteHpza3N4VjRyY29CeGdDakM3UjF4MlctcXJGdzRmdmZyaGV2WWdOc3hpbk56RExjdHNTaktEeDdDSnN3UEhYZmp6bDBiRHl3am5lS3dON0x5cWhEN0ZKcVNaOVBsTEdfXzk3ZnhxTUg0S201TzcwaGNVUGNqb1I1ZFpjcVF2QzR5WXpVQ3hINWJuYkd3TzBhWUJMWnNYRnNzWTVNeDlBYmlOd0JIYWp0cWhndkRJRXg5c2FSdUZycUlHZ3V5UWdGakJmRzV1a0QxYXFvUVFza2JMaER5M29MWUxLYllpYXBDNGVBcTBmZlVrYXNRNk56US1ZSXlxSjlFSFFodGpiLUE0dG1GYTV1dUpvOUpxVWp2MUJsUlMyNmNJOGJySlBWa1p0M2liMEloNW1nRTFfamdjWVJzLUdROW1Fd0Z4YWU4dU1oNGd2YWNwajZJdW94eEVKX1ppMmJBRmtPYUVoOHktNjVpcjBYY2VwN0diU2tFc2dOLTR6ZnRKT2Z5TnlYQ2wtTHpyVkNDbHFweWJzQWp6anp4WkZfRWhBcl9iZzhIT0p1bVQ2YzlyMGE1ekt1aDQ4cGxWVzZqeWt5VjE4Vml3UkdlR2oybHhKT1dEMDdkUHRjTjBKWVV0SmQyN01ZNnNacHVtT2N0SzVRaHdsMlBPREY4bW1pN1Y5MFNYVXR5Zlg4SVA3T1lON0ozYUFUUVZHYzRoazFqT190TzFPaHZiaklwa1BlNXpqdDJ0UVFCVGozdk5SUzFVMnRaOWpISDc4SDIwODg4TmoyemtVa0VHUFBLRFBsT3ZLQ21fVDdPUXJ1Vjk5VzlQVjdBbklmV05OUGlTNER3UG9IZTg0VC01dzZ5cWNiNkdnX09nNFdiamc0a183MXg1enREaWpNRzA3NXZEbm5tUENpWk04aDNTbnRpNWNObXkwZkZhaFN4Wm9hTklVUnVTbEI1ME5sRGhIMFdkeWViVkY4Ny1ZOGstMXI1bk02Zlg1Sk5fX192dTV1SVA4VHFSTWt6Uk9teDdjSWlESmxSeEtSTks4b2FwRTN0cTljTnBDdVZ1b1ZCVC1JZ1RzY2tuV0o2aGd0czRZLVF1WmZ6MnkzZy1nSUpCQ0lqblNTNDFiajZxMnBXeVBnWjVxeGpIRnY3aUlpdnhRZGp5UnNOb2Qza1BFUm1kZVNCa2xvaHYtVkpqWGpzWVVTalQxWDdTQnJ3dzNFSlJJc1lsWEc0LUdmSlJmQmh5alAtdG9sSHQ4OU04YzE4c0RDTm1NMkg2aDlxLWtidGthRUxXc1pDSHZyandFYnBySWtfTFBXM3UwLUJpamJRSUU1akRiaGxXUXhfT2xvOXpGRmJYMDI4Yk4tazlGVHdlSVVUdkZXNUFrWml3NklOWGJLQTFxWjlvcWowOVJfMExsNGozOW53WnB5algya2xPelhuai1kMkswYXMzODJUeVVJYnh2TEF0eU5Walp2WnhKV1lrQzRVT3p0WDQ2eEhPXzdTSllNajJRR1k2SGVfTXAyVXRLaFB3SERLR3duLUtlVHR4VXlKa25ldVVGajlKWk5QaGlIMW9NNUdjMzJvZUp2Rm9hbVU4dlJRTHBVU081SVA3TlJuRTdVSHh1MHVOd1o0dHF5bVB6Sk9JSVdySU1mVXQ0c0dmZWFBSUtkNlN1N2FKc3NBVnA4bzQ2ZjhOUXlYVVFFcDB1Q1JMVWFGcWV6dkx3PQ==)
        APPLE_ID: Encrypted(Z0FBQUFBQmdvNU5uM1FwWnF0N2s0dnA3elgwaFJoTUk5SXA4ZEJ3NTNEZmhTcmNUUHRVVkE0OTNuM3RXaGZrZ1FwMnZrbkxyZnF1WFFoZ3ZFcGRCZHBGaG9HZGJPSkRsVVE9PQ==) # <-- Put your encrypted Apple Id email address here
        APPLE_APP_SPECIFIC_PASSWORD: Encrypted(Z0FBQUFBQmdvNU41Vm12cWotcDZacVZZU0hZVFRWTE1VUmtvQ1l2QWtQZC1oV2tzblkxbFZSSlpDdW5pTGI4Qzd1cklNVHF3UDJfY3Ztc2UyamctZjllSHNUY19EOTBkVUE9PQ==) # <-- Put your encrypted App Specific password here
        BUNDLE_ID: "ru.barnlab.kassis" # <-- Put your bundle id here
        APP_STORE_ID: 1111111111 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID. 
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
